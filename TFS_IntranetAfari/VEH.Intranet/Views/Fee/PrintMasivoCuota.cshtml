@model VEH.Intranet.ViewModel.Fee.PrintMasivoCuotaViewModel
@{
    ViewBag.Title = "Imprimir Cuotas";
    var DictCuotaDepartamento = Model.LstCuota.ToDictionary(x => x.DepartamentoId, x => x);
}

@section Breadcrumbs{
    <li><a href="@Url.Action("LstEdificio", "Building")">Lista de Edificios</a></li>
    <li><a href="@Url.Action("LstOpcionEdificio", "Building", new { EdificioId = Model.EdificioId })">Opciones Edificio</a></li>
}

@section Styles{
    <style>
        .table-responsive {
            overflow-x: auto;
        }

        .table-cuota-masiva th {
            width: 70px;
        }

        .table-cuota-masiva input {
            width: 70px;
            margin: 0;
            padding: 0;
        }
    </style>
}

<div class="row">
    <div class="col-sm-12">
        <div class="panel panel-inverse">
            <div class="panel-body">
                <h4><i class="fa fa-building-o"></i>&nbsp;Edificio</h4>
                <dl class="dl-horizontal">
                    <dt>Nombre</dt>
                    <dd>@Model.Edificio.Nombre</dd>
                </dl>
            </div>
        </div>
    </div>
</div>
<div>
    <div>
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse" data-original-title="" title="Colapsar / Expandir"><i class="fa fa-minus"></i></a>
                </div>
                <h4 class="panel-title"><i class="fa fa-filter"></i>&nbsp;&nbsp;Filtro</h4>
            </div>
            <div class="panel-body">
                <form class="form-horizontal">
                    @Html.HiddenFor(x => x.EdificioId)
                    <div class="form-group">
                        <label class="col-md-2 control-label">Unidad de tiempo</label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(x => x.UnidadTiempoId, Model.LstComboUnidadTiempo, new { @class = "form-control select2" })
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <div class="col-md-2 col-md-offset-10 ui-sortable">
                            <button type="submit" class="btn btn-sm btn-primary m-r-5"><i class="fa fa-search"></i>&nbsp;&nbsp;Buscar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@if (Model.UnidadTiempoId.HasValue)
{
    var disabledStyle = "background: #e5e9ed;cursor: not-allowed;box-shadow: none;border: 1px solid #ccd0d4;";

    <div>
        <div>
            <div class="panel panel-inverse">
                <div class="panel-heading">
                    <h4 class="panel-title"><i class="fa fa-list"></i>&nbsp;&nbsp;Listado</h4>
                </div>
                <div class="panel-body">
                    @if (!String.IsNullOrEmpty(Model.RutaUltimo))
                    {
                        <a class="btn btn-warning" href="@Model.RutaUltimo"><i class="fa fa-download"></i> Descargar Último Recibo Generado</a>
                    }
                    <form action="@Url.Action("PrintMasivoCuota")" method="post">
                        @Html.HiddenFor(x => x.EdificioId)
                        @Html.HiddenFor(x => x.UnidadTiempoId)
                        <div class="table-responsive">
                            <table class="table table-condensed table-cuota-masiva">
                                <thead>
                                    <tr>
                                        <th class="text-center">PROPORCIONAL</th>
                                        <th class="text-center">GASTO</th>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Lectura Anterior m³</th>
                                        <th class="text-center">Lectura Actual m³</th>
                                        <th class="text-center">Consumo del mes m³</th>
                                        <th class="text-center">Consumo S/</th>
                                        <th class="text-center">Area Comun S/</th>
                                        <th class="text-center">Alcantarillado</th>
                                        <th class="text-center">Cargo Fijo</th>
                                        <th class="text-center">IGV</th>
                                        <th class="text-center">Consumo Agua S/</th>
                                        <th class="text-center">Cuota S/</th>
                                        <th class="text-center">Extraordinario S/</th>
                                        <th class="text-center">TOTAL S/</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="12" class="text-center">TOTALES</td>
                                    </tr>
                                    <tr class="info">
                                        <td class="text-center"></td>
                                        <td class="text-center"></td>
                                        <td class="text-center">@Model.LstDepartamento.Count()</td>
                                        <td class="text-center"><span id="comun-lectura-anterior">@String.Format("{0:#,0.00}", Model.LstDepartamento.Sum(x => x.LecturaAgua))</span></td>
                                        <td class="text-center"><span id="comun-lectura-actual"></span></td>
                                        <td class="text-center"><span id="comun-consumo-agua"></span></td>
                                        <td class="text-center"><span>@String.Format("{0:#,0.00}", Model.CuotaComun.TotalMontoAgua)</span></td>
                                        <td class="text-center"><span>@String.Format("{0:#,0.00}", Model.CuotaComun.TotalAreaComun)</span></td>
                                        <td class="text-center"><span>@String.Format("{0:#,0.00}", Model.CuotaComun.TotalAlcantarillado)</span></td>
                                        <td class="text-center"><span>@String.Format("{0:#,0.00}", Model.CuotaComun.TotalCargoFijo)</span></td>
                                        <td class="text-center"><span id="comun-igv"></span></td>
                                        <td class="text-center"><span id="comun-consumo-agua-total"></span></td>
                                        <td class="text-center"><span id="comun-cuota"></span></td>
                                        <td class="text-center"><span id="comun-cuota-extraordinaria"></span></td>
                                        <td class="text-center"><span id="comun-total"></span></td>
                                    </tr>
                                    <tr>
                                        <td colspan="12" class="text-center">DETALLE POR DEPARTAMENTO</td>
                                    </tr>
                                    @{ var existeAlgunaCuota = false;}
                                    @for (int i = 0; i < Model.LstDepartamento.Count; ++i)
                                    {
                                        var item = Model.LstDepartamento[i];
                                        //@foreach (var item in Model.LstDepartamento)
                                        //{
                                        var tieneCuota = DictCuotaDepartamento.ContainsKey(item.DepartamentoId);
                                        if (tieneCuota)
                                        {
                                            existeAlgunaCuota = true;
                                        }
                                        var cuota = tieneCuota ? DictCuotaDepartamento[item.DepartamentoId] : new VEH.Intranet.Models.Cuota();
                                        var montoCuota = cuota.Monto == Decimal.Zero ? Model.Edificio.MontoCuota : cuota.Monto;

                                        <tr class="row-departamento" data-departamento-id="@item.DepartamentoId">
                                            <td class="text-center"><input name="hidden-proporcional-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@Model.LstFactorProporcional[i]" /></td>
                                            <td class="text-center"><input name="hidden-gasto-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@Model.LstFactorGasto[i]" /></td>
                                            <td class="text-center">@item.Numero</td>
                                            <td class="text-center"><span id="cuota-lectura-anterior-@item.DepartamentoId">@String.Format("{0:#,0.00}", item.LecturaAgua) <input name="comun-lectura-anterior-@item.DepartamentoId" type="hidden" value="@String.Format("{0:#,0.00}", item.LecturaAgua)" /></span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.LecturaAgua)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.ConsumoAgua)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.ConsumoSoles)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.AreaComun)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.Alcantarillado)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.CargoFijo)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.IGV)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.ConsumoAguaTotal)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", montoCuota)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.CuotaExtraordinaria)</span></td>
                                            <td class="text-center"><span>@String.Format("{0:#,0.00}", cuota.Total)</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="form-horizontal form-bordered">
                            <div class="form-group">
                                <div class="col-md-6">
                                    @Html.LabelFor(x => x.FechaEmision, new { @class = "col-md-4 control-label" })
                                    <div class="col-md-8">
                                        @Html.DateTextBoxFor(x => x.FechaEmision, new { @class = "form-group" })
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    @Html.LabelFor(x => x.FechaVencimiento, new { @class = "col-md-4 control-label" })
                                    <div class="col-md-8">
                                        @Html.DateTextBoxFor(x => x.FechaVencimiento, new { @class = "form-group" })
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-4 col-md-offset-10 ui-sortable pull-right">
                                @Html.CheckBoxFor(x => x.AplicaSeparacion)<label>¿Separar Extraordinaria?</label>
                                <button type="submit" class="cancel btn btn-sm btn-primary m-r-5"><i class="fa fa-print"></i>&nbsp;&nbsp;Exportar</button>
                                @if (existeAlgunaCuota)
                                {
                                    <a href="@Url.Action("ExportTextFile", "Fee", new {UnidadTiempoId = Model.UnidadTiempoId,  EdificioId = Model.EdificioId})" class="btn btn-sm btn-default"><i class="fa fa-file-text"></i>&nbsp;Exportar txt BCP</a>
                                }
                                <a href="@Url.Action("LstEdificio", "Building")" class="btn btn-sm btn-default"><i class="fa fa-arrow-left"></i>&nbsp;Cancelar</a>
                            </div>
                            <div class="col-md-4 col-md-offset-10 ui-sortable pull-right">
                                &nbsp;
                            </div>
                            <div class="col-md-4 col-md-offset-10 ui-sortable pull-right">
                                <input style="display:none" name="seImprimeCE" id="seImprimeCE" value="0"/>
                                <button id="btnece" style="display:none" type="submit" class="cancel btn btn-sm btn-primary m-r-5"><i class="fa fa-print"></i>&nbsp;&nbsp;Exportar Extraordinaria</button>
                            </div>
                            <center>
                                <label style="font-size:14px;color:red"><span>Recordatorio: Al exportar un recibo, la información del mismo será recalculada.</span></label>
                            </center>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


}

@section Scripts{
    <script>
        $('#AplicaSeparacion').on('change',function(){
            if ($(this).prop('checked')) {
                $('#btnece').show();
            }
            else {
                $('#btnece').hide();
            }
        });

        $('#btnece').on("click",function(e) {
            $('#seImprimeCE').val('1');
         });
    </script>>    
}