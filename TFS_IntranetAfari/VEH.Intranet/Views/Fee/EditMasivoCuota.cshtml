@model VEH.Intranet.ViewModel.Fee.EditMasivoCuotaViewModel

@{
    ViewBag.Title = "Lista de cuotas";
    var DictCuotaDepartamento = Model.LstCuota.ToDictionary(x => x.DepartamentoId, x => x);
    Dictionary<String, Decimal> dicCuotas = new Dictionary<String, Decimal>();
}

@section Breadcrumbs{
    <li><a href="@Url.Action("LstEdificio", "Building")">Lista de Edificios</a></li>
    <li><a href="@Url.Action("LstOpcionEdificio", "Building", new { EdificioId = Model.EdificioId })">Opciones Edificio</a></li>
}

@section Styles{
    <style>
        .table-responsive {
            overflow-x: auto;
        }

        .table-cuota-masiva th {
            width: 70px;
        }

        .table-cuota-masiva input {
            width: 70px;
            margin: 0;
            padding: 0;
        }
    </style>
}
<div class="row">
    <div class="col-sm-12">
        <div class="panel panel-inverse">
            <div class="panel-body">
                <h4><i class="fa fa-building-o"></i>&nbsp;Edificio</h4>
                <div class="row">
                    <div class="col-md-2">
                        <dl class="dl-horizontal">
                            <dt>Nombre</dt>
                            <dd>@Model.Edificio.Nombre</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <dl class="dl-horizontal">
                            <dt>Acumulado</dt>
                            <dd>@Model.Acumulado</dd>
                            <dt>Unidad de Tiempo</dt>
                            <dd>@Model.UltimaUnidadTiempoAcumulado</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div>
    <div>
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse" data-original-title="" title="Colapsar / Expandir"><i class="fa fa-minus"></i></a>
                </div>
                <h4 class="panel-title"><i class="fa fa-filter"></i>&nbsp;&nbsp;Filtro</h4>
            </div>
            <div class="panel-body">
                <form class="form-horizontal">
                    @Html.HiddenFor(x => x.EdificioId)
                    <div class="form-group">
                        <label class="col-md-2 control-label">Unidad de tiempo</label>
                        <div class="col-md-8">
                            @Html.DropDownListFor(x => x.UnidadTiempoId, Model.LstComboUnidadTiempo, new { @class = "form-control select2" })
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <div class="col-md-2 col-md-offset-10 ui-sortable">
                            <button type="submit" class="btn btn-sm btn-primary m-r-5"><i class="fa fa-search"></i>&nbsp;&nbsp;Buscar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


@if (Model.UnidadTiempoId.HasValue)
{
    <div>
        <div>
            <div class="panel panel-inverse">
                <div class="panel-heading">
                    <div class="panel-heading-btn">
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse" data-original-title="" title="Colapsar / Expandir"><i class="fa fa-minus"></i></a>
                    </div>
                    <h4 class="panel-title"><i class="fa fa-plus"></i>&nbsp;&nbsp;Comandos avanzados</h4>
                </div>
                <div class="panel-body">
                    <div class="">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <div class="col-sm-3">
                                    <label class=" control-label">Cuota de Agua Fija:</label>
                                    <div class="1">
                                        <input type="text" class="form-control" id="FijarCuotaAgua" />
                                    </div>
                                    <div class=" ui-sortable ">
                                        <button class="btn btn-sm btn-primary m-r-5" onclick="CambiarConsumoAguaTotal()"><i class="fa fa-save"></i>&nbsp;&nbsp;Reemplazar</button>
                                    </div>
                                </div>

                                <div class="col-sm-3">
                                    <label class=" control-label">Cuotas por defecto:</label>

                                    <div class="ui-sortable ">
                                        <button class="btn btn-sm btn-primary m-r-5" onclick="CambiarUsarDefaults()"><i class="fa fa-save"></i>&nbsp;&nbsp;Utilizar</button>
                                    </div>
                                </div>
                                <div class="col-sm-3">


                                    <label class="control-label">Anular IGV:</label>

                                    <div class=" ui-sortable ">
                                        <button class="btn btn-sm btn-primary m-r-5" onclick="AnularIgv()"><i class="fa fa-save"></i>&nbsp;&nbsp;Anular</button>
                                    </div>
                                    <br />
                                </div>
                                <div class="col-sm-3">
                                    <label class="control-label">Cuota extraordinaria comun:</label>
                                    <div class="">
                                        <input type="text" class="form-control" id="FijarCuotaExtraordinaria" />
                                    </div>
                                    <div class="ui-sortable ">
                                        <button class="btn btn-sm btn-primary m-r-5" onclick="CambiarCuotaExtraordinariaTotal()"><i class="fa fa-save"></i>&nbsp;&nbsp;Reemplazar</button>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <label class=" control-label">Total recibo agua:</label>
                            <div class="1">
                                <input type="text" class="form-control" id="TotalReciboCuotaAgua" />
                            </div>
                            <div class=" ui-sortable ">
                                <button class="btn btn-sm btn-primary m-r-5" onclick="CambiarConsumoAguaTotalRecibo()"><i class="fa fa-save"></i>&nbsp;&nbsp;Calcular area común</button>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
    <form action="@Url.Action("EditMasivoCuota")" method="post" onsubmit="return confirm('¿Está seguro de registrar todas las cuotas ingresadas?')">
        @{var disabledStyle = "background: #e5e9ed;cursor: not-allowed;box-shadow: none;border: 1px solid #ccd0d4;";}

        <div>
            <div>
                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-list"></i>&nbsp;&nbsp;Listado</h4>
                    </div>
                    <div class="panel-body">

                        @Html.HiddenFor(x => x.EdificioId)
                        @Html.HiddenFor(x => x.UnidadTiempoId)
                        <div class="table-responsive">
                            <table class="table table-condensed table-cuota-masiva">
                                <thead>
                                    <tr>
                                        <th class="text-center" hidden>PROPORCIONAL</th>
                                        <th class="text-center" hidden>GASTO</th>
                                        <th class="text-center">#</th>
                                        <th class="text-center">Lectura Anterior m³</th>
                                        <th class="text-center">Lectura Actual m³</th>
                                        <th class="text-center">Consumo del mes m³</th>
                                        <th class="text-center">Consumo S/</th>
                                        <th class="text-center">Area Comun S/</th>
                                        <th class="text-center">Alcantarillado</th>
                                        <th class="text-center">Cargo Fijo</th>
                                        <th class="text-center">IGV</th>
                                        <th class="text-center">Consumo Agua S/</th>
                                        <th class="text-center">Cuota S/</th>
                                        <th class="text-center">Extraordinario S/</th>
                                        <th class="text-center">Otros</th>
                                        <th class="text-center">TOTAL S/</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="12" class="text-center">TOTALES</td>
                                    </tr>
                                    <tr class="info">
                                        <td class="text-center" hidden></td>
                                        <td class="text-center" hidden></td>
                                        <td class="text-center">@Model.LstDepartamento.Count()</td>
                                        <td class="text-center"><span id="comun-lectura-anterior">@String.Format("{0:N}", Model.LstDepartamento.Sum(x => x.LecturaAgua))</span></td>
                                        <td class="text-center"><span id="comun-lectura-actual"></span></td>
                                        <td class="text-center"><span id="comun-consumo-agua"></span></td>
                                        <td class="text-center"><input name="comun-consumo-soles" type="text" value="@String.Format("{0:N}",Model.CuotaComun.TotalMontoAgua)" /></td>
                                        <td class="text-center"><input name="comun-area-comun" type="text" value="@String.Format("{0:N}",Model.CuotaComun.TotalAreaComun)" /></td>
                                        <td class="text-center"><input name="comun-alcantarillado" type="text" value="@String.Format("{0:N}",Model.CuotaComun.TotalAlcantarillado)" /></td>
                                        <td class="text-center"><input name="comun-cargo-fijo" type="text" value="@String.Format("{0:N}",Model.CuotaComun.TotalCargoFijo)" /></td>
                                        <td class="text-center"><span id="comun-igv"></span></td>
                                        <td class="text-center"><span id="comun-consumo-agua-total"></span></td>
                                        <td class="text-center"><span id="comun-cuota"></span></td>
                                        <td class="text-center"><span id="comun-cuota-extraordinaria"></span></td>
                                        <td class="text-center"><span>@String.Format("{0:N}", Model.TotalConsumoIndividual)</span></td>
                                        <td class="text-center"><span id="comun-total" name="comun-total"></span></td>
                                        @*<td class="text-center"><span id="comun-total" value="@String.Format("{0:0,0.00}",Model.CuotaComun.SaldoMes)"></span></td>*@
                                    </tr>
                                    <tr>
                                        <td colspan="12" class="text-center">DETALLE POR DEPARTAMENTO</td>
                                    </tr>
                                    @for (int i = 0; i < Model.LstDepartamento.Count; ++i)
                                    {
                                        var item = Model.LstDepartamento[i];
                                        //@foreach (var item in Model.LstDepartamento)
                                        //{
                                        var tieneCuota = DictCuotaDepartamento.ContainsKey(item.DepartamentoId);
                                        var cuota = tieneCuota ? DictCuotaDepartamento[item.DepartamentoId] : new VEH.Intranet.Models.Cuota();
                                        var montoCuota = cuota.Monto == Decimal.Zero ? Model.Edificio.MontoCuota : cuota.Monto;
                                        var LecturaAnterior = item.LecturaAgua;
                                        try
                                        {
                                            LecturaAnterior = Model.LstCuotaAnterior.First(X => X.DepartamentoId == item.DepartamentoId).LecturaAgua;
                                        }
                                        catch (Exception ex)
                                        {

                                        }
                                        <tr class="row-departamento" data-departamento-id="@item.DepartamentoId">
                                            <td class="text-center" hidden><input name="hidden-proporcional-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@Model.LstFactorProporcional[i]" /></td>
                                            <td class="text-center" hidden>
                                                <input name="hidden-gasto-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@Model.LstFactorGasto[i]" />
                                                <input name="hidden-cuotadefault-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@Model.LstCuotaDefault[i]" />
                                            </td>
                                            <td class="text-center">@item.Numero</td>
                                            <td class="text-center">
                                                <span id="cuota-lectura-anterior-@item.DepartamentoId">
                                                    @*@String.Format("{0:0,0.00}", LecturaAnterior)*@
                                                    @*<input name="comun-lectura-anterior-@item.DepartamentoId" value="@String.Format("{0:0,0.00}", LecturaAnterior)" />*@
                                                    <input name="comun-lectura-anterior-@item.DepartamentoId" value="@String.Format("{0:0,0.00}", cuota.LecturaAnterior.HasValue ? cuota.LecturaAnterior : LecturaAnterior)" />
                                                </span>
                                            </td>
                                            <td class="text-center"><input name="cuota-lectura-actual-@item.DepartamentoId" type="text" value="@String.Format("{0:0,0.00}",cuota.LecturaAgua)" /></td>
                                            <td class="text-center"><input name="cuota-consumo-agua-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.ConsumoAgua)" /></td>
                                            <td class="text-center"><input name="cuota-consumo-soles-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.ConsumoSoles)" /></td>
                                            <td class="text-center"><input name="cuota-area-comun-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.AreaComun)" /></td>
                                            <td class="text-center"><input name="cuota-alcantarillado-@item.DepartamentoId" class="al" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.Alcantarillado)" /></td>
                                            <td class="text-center"><input name="cuota-cargo-fijo-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.CargoFijo)" /></td>
                                            <td class="text-center"><input name="cuota-igv-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.IGV)" /></td>
                                            <td class="text-center"><input name="cuota-consumo-total-agua-@item.DepartamentoId" type="text" readonly="readonly" style="@disabledStyle" value="@String.Format("{0:0,0.00}",cuota.ConsumoAguaTotal)" /></td>
                                            <td class="text-center"><input name="cuota-cuota-@item.DepartamentoId" type="text" value="@String.Format("{0:0,0.00}",montoCuota)" /></td>
                                            <td class="text-center"><input name="cuota-cuota-extraordinaria-@item.DepartamentoId" type="text" value="@String.Format("{0:0,0.00}",cuota.CuotaExtraordinaria)" /></td>

                                            <td class="text-center"><input readonly="readonly" style="@disabledStyle" type="text" value="@String.Format("{0:0,0.00}",cuota.ConsumoIndividual.Where(x => x.Estado == ConstantHelpers.EstadoActivo).Sum(x => x.Monto))" /></td>
                                            <td class="text-center"><input name="cuota-total-@item.DepartamentoId" type="text" value="@String.Format("{0:0,0.00}",cuota.Total)" class="total"/></td>
                                        </tr>
                                        dicCuotas.Add("cuota-total-" + item.DepartamentoId, cuota.Total);
                                    }
                                </tbody>
                            </table>

                            <div><p>&nbsp;</p></div>

                            <div class="form-group">
                                <div class="ui-sortable">
                                    <button type="submit" class="btn btn-sm btn-primary m-r-10 pull-right cancel"><i class="fa fa-save"></i>&nbsp;&nbsp;Guardar</button>

                                    <a href="@Url.Action("LstEdificio", "Building")" class="btn btn-sm btn-default m-r-5 pull-right"><i class="fa fa-arrow-left"></i>&nbsp;Cancelar</a>
                                    @if (Model.CantExtraordinariaManual == 0)
                                    {
                                        <a class="btn btn-warning" @Data.ModalLink("_AddEditMCuotaExtraordinaria", "Fee", new { EdificioId = Model.EdificioId, UnidadTiempoId = Model.UnidadTiempoId })>Agregar Cuotas Extraordinarias</a>
                                    }
                                    else
                                    {
                                        <a class="btn btn-danger" href="@Url.Action("LstCuotaExtraordinaria","Fee",new { EdificioId = Model.EdificioId, UnidadTiempoId = Model.UnidadTiempoId})">Lista de cuotas extraordinarias</a>
                                    }
                                    <a class="btn btn-success" href="@Url.Action("LstConsumoIndividual","Fee",new { EdificioId = Model.EdificioId, UnidadTiempoId = Model.UnidadTiempoId})">Lista de consumos individuales</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </form>
            }



<div id="myModal" class="modal fade" tabindex="-1" role="dialog" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">Agregar Gasto Común</h4>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label class="col-md-3 control-label">Concepto</label>
                    <div class="col-md-9">
                        <input type="text" class="form-control" id="in-con" />
                    </div>
                </div>
                <div><p>&nbsp;</p></div>
                <div class="form-group">
                    <label class="col-md-3 control-label">Detalle</label>
                    <div class="col-md-9">
                        <input type="text" class="form-control" id="in-det" />
                    </div>
                </div>
                <div><p>&nbsp;</p></div>

                <div class="form-group">
                    <label class="col-md-3 control-label">Monto</label>
                    <div class="col-md-9">
                        <input type="text" class="form-control" id="in-mon" />
                    </div>
                </div>
                <div><p>&nbsp;</p></div>

            </div> <!-- / .modal-body -->
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-agregar-gastos">Agregar&nbsp;<span class="fa fa-plus"></span></button>
            </div>
        </div> <!-- / .modal-content -->
    </div> <!-- / .modal-dialog -->
</div> <!-- /.modal -->
<!-- / Modal -->


@section Scripts{

    <script>
        var id = @((Model.LstGastoCuotaComun==null)?0:Model.LstGastoCuotaComun.Count+5);
        //Script de los gastos
        function AgregarGasto()
        {
            id++;
            var concepto= $("#in-con").val();
            var detalle=$("#in-det").val();
            var monto=$("#in-mon").val();

            var extrarow = "";
            extrarow+="<tr>"
                    +   "<td>" + concepto.toString()
                    +   "</td>"
                    +   "<td>" + detalle.toString()
                    +   "</td>"
                    +   "<td>" + monto.toString()
                    +   "</td>"
                    +   "<td>" +"<a class='btn btn-sm btn-primary' data-accion='eliminar-filtro'><span class='fa fa-trash-o'></span></a>"
                    +     '<input type="hidden" name="gasto-edificio-concepto-' + id.toString() + '" value="' + concepto.toString() + '"/>'
                    +     '<input type="hidden" name="gasto-edificio-detalle-' + id.toString() + '" value="' + detalle.toString() + '"/>'
                    +     '<input type="hidden" name="gasto-edificio-monto-' + id.toString() + '" value="' + monto.toString() + '"/>'
                    +   "</td>"
                    + "</tr>";
            $("#tabla-gastos > tbody").append(extrarow);
        }


        $(document).on('click', '[data-accion="eliminar-filtro"]', function () {
            $(this).closest('tr').remove();
        });
    </script>

    <script>

        var nroDepartamentos = @Model.LstDepartamento.Count();
        var total = @Model.Total;
        var tipoFactor = @Model.Factor;

        var totalFactorGasto = @Model.TotalFactorGasto;
        var totalFactorConsumoAgua = @Model.TotalFactorConsumoAgua;
        var totalFactorProporcional = @Model.TotalFactorProporcional;

        var tipoFactorAreaComun = @Model.FactorAreaComun;
        var tipoFactorAlcantarillado = @Model.FactorAlcantarillado;
        var tipoFactorCargoFijo = @Model.FactorCargoFijo;

        function sumaTodo(selector)
        {
            var suma = 0;
            $(selector).each(function (i, n) {
                $n = $(n);
                var valor = parseFloat($n.val().replace(",",""), 10);
                suma += valor;
                $n.val(valor.toFixed(2));
            });
            return suma.toFixed(2);
        }

        function obtenerDepartamento(selector)
        {
            return selector.substring(selector.lastIndexOf('-')+1);
        }

        function actualizarTotales()
        {
            actualizarTotalesCabeceras();

            total = @Model.Total;
            tipoFactor = @Model.Factor;

            totalFactorGasto = @Model.TotalFactorGasto;
            totalFactorConsumoAgua = @Model.TotalFactorConsumoAgua;
            totalFactorProporcional = @Model.TotalFactorProporcional;

            tipoFactorAreaComun = @Model.FactorAreaComun;
            tipoFactorAlcantarillado = @Model.FactorAlcantarillado;
            tipoFactorCargoFijo = @Model.FactorCargoFijo;

            if(tipoFactorAreaComun == 3 || tipoFactorAlcantarillado == 3 || tipoFactorCargoFijo == 3)
            {
                totalFactorConsumoAgua = 0;
                $('[name^="cuota-lectura-actual"]').each(function (i, e) {
                    totalFactorConsumoAgua += parseFloat(e.value, 10);
                });

            }

            $('[name^="cuota-consumo-soles"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                actualizarTotalesDepartamento(departamentoId);
            });

            $('[name^="cuota-cuota-extraordinaria"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                fixExtraordinario(departamentoId);
            });

            actualizarTotalesCabeceras();
        }

        function fixExtraordinario(departamentoId) {

            var cuotaExtraordinaria = parseFloat($('[name="cuota-cuota-extraordinaria-' + departamentoId + '"]').val(), 10);
            if (isNaN(cuotaExtraordinaria)) cuotaExtraordinaria = 0;
            $('[name="cuota-cuota-extraordinaria-' + departamentoId + '"]').val(cuotaExtraordinaria);
        }

        function actualizarConsumoAgua()
        {
            debugger;
            $('[name^="cuota-consumo-agua"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                //var valorAnterior = parseFloat($('#cuota-lectura-anterior-'+departamentoId).text().replace(",",""), 10);
                var valorAnterior = parseFloat($('#cuota-lectura-anterior-'+departamentoId).find("input").val().replace(",",""), 10);
                var valorActual = parseFloat($('[name^="cuota-lectura-actual-' + departamentoId+'"]').val(), 10);
                $('[name^="cuota-lectura-actual-' + departamentoId+'"]').val(valorActual.toFixed(2));
                var valorConsumoAgua = (valorActual-valorAnterior).toFixed(2);
                $('[name^="cuota-consumo-agua-' + departamentoId+'"]').val(Math.abs(valorConsumoAgua));
                if(valorConsumoAgua < 0){
                    $('[name^="cuota-consumo-agua-' + departamentoId+'"]').attr('style','background: #e5e9ed;cursor: not-allowed;box-shadow: none;border: 1px solid #ff0000;');
                }
                else{
                    $('[name^="cuota-consumo-agua-' + departamentoId+'"]').attr('style','background: #e5e9ed;cursor: not-allowed;box-shadow: none;border: 1px solid #ccd0d4;');
                }
            });

            $("#comun-lectura-actual").text(sumaTodo('[name^="cuota-lectura-actual"]'));
            $("#comun-consumo-agua").text(sumaTodo('[name^="cuota-consumo-agua"]'));

            var valorTotalAgua = parseFloat($('[name="comun-consumo-soles"]').val(), 10);
            $('[name="comun-consumo-soles"]').val(valorTotalAgua.toFixed(7));

            var consumoAgua = parseFloat($('#comun-consumo-agua').text(), 10);
            var consumoSoles = parseFloat($('[name="comun-consumo-soles"]').val(), 10);
            $('[name^="cuota-consumo-soles"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                var consumoDepartamento = parseFloat($('[name^="cuota-consumo-agua-'+departamentoId+'"]').val(),10);
                //$(e).val((consumoDepartamento*valorTotalAgua/consumoAgua).toFixed(2));
                $(e).val((consumoDepartamento*consumoSoles).toFixed(2));
            });
        }


        function actualizarTotalesDepartamento(departamentoId)
        {
            tipoFactor = @Model.Factor;
            total = @Model.Total;

            totalFactorGasto = @Model.TotalFactorGasto;
            totalFactorConsumoAgua = @Model.TotalFactorConsumoAgua;
            totalFactorProporcional = @Model.TotalFactorProporcional;

            tipoFactorAreaComun = @Model.FactorAreaComun;
            tipoFactorAlcantarillado = @Model.FactorAlcantarillado;
            tipoFactorCargoFijo = @Model.FactorCargoFijo;


            var consumoAgua = 0;
            if(tipoFactorAreaComun == 3 || tipoFactorAlcantarillado == 3 || tipoFactorCargoFijo == 3)
            {
                totalFactorConsumoAgua = 0;
                //$('[name^="cuota-lectura-actual"]').each(function (i, e) {
                //    totalFactorConsumoAgua += parseFloat(e.value, 10);
                //});
                //$('[name^="comun-lectura-anterior"]').each(function (i, e) {
                //    totalFactorConsumoAgua -= parseFloat(e.value, 10);
                //});
                $('[name^="cuota-consumo-agua"]').each(function (i, e) {
                    totalFactorConsumoAgua += parseFloat(e.value, 10);
                });
                //totalFactorConsumoAgua = 1117;
                consumoAgua = Math.abs(parseFloat($('[name="cuota-lectura-actual-'+departamentoId+'"]').val(), 10)-parseFloat($('[name="comun-lectura-anterior-'+departamentoId+'"]').val(), 10));
            }

            var numerador = 1, denominador = 1;
            debugger;
            if(tipoFactorAreaComun == 1) {
                numerador = parseFloat($('[name="hidden-proporcional-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorProporcional;
            }
            else if(tipoFactorAreaComun == 2) {
                numerador = parseFloat($('[name="hidden-gasto-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorGasto;
            }
            else {
                numerador = consumoAgua;
                denominador = totalFactorConsumoAgua;
            }

            var valor = parseFloat($('[name="comun-area-comun"]').val(), 10);
            $('[name="comun-area-comun"]').val(valor.toFixed(2));
            var cuotaPorDepartamento = ( valor * numerador / denominador).toFixed(2);
            $('[name^="cuota-area-comun-'+departamentoId+'"]').val(cuotaPorDepartamento);


            if(tipoFactorAlcantarillado == 1) {
                numerador = parseFloat($('[name="hidden-proporcional-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorProporcional;
            }
            else if(tipoFactorAlcantarillado == 2) {
                numerador = parseFloat($('[name="hidden-gasto-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorGasto;
            }
            else {
                numerador = consumoAgua;
                denominador = totalFactorConsumoAgua;
            }
            
            var valor = parseFloat($('[name="comun-alcantarillado"]').val().replace('.','').replace(',',''),10)/100;
            $('[name="comun-alcantarillado"]').val((valor).toFixed(2));
            //Aqui se calcula el alcantarillado
            var cuotaPorDepartamento = ( valor * numerador / denominador).toFixed(2);
            $('[name^="cuota-alcantarillado-'+departamentoId+'"]').val(cuotaPorDepartamento);

            if(tipoFactorCargoFijo == 1) {
                numerador = parseFloat($('[name="hidden-proporcional-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorProporcional;
            }
            else if(tipoFactorCargoFijo == 2) {
                numerador = parseFloat($('[name="hidden-gasto-'+departamentoId+'"]').val(), 10);
                denominador = totalFactorGasto;
            }
            else {
                numerador = consumoAgua;
                denominador = totalFactorConsumoAgua;
            }

            var valor = parseFloat($('[name="comun-cargo-fijo"]').val(), 10);
            $('[name="comun-cargo-fijo"]').val(valor.toFixed(2));
            var cuotaPorDepartamento = ( valor * numerador / denominador).toFixed(2);
            $('[name^="cuota-cargo-fijo-'+departamentoId+'"]').val(cuotaPorDepartamento);


            var consumoSoles = parseFloat($('[name^="cuota-consumo-soles-' + departamentoId+'"]').val());
            if(isNaN(consumoSoles)) consumoSoles = 0;
            var areaComun = parseFloat($('[name^="cuota-area-comun-' + departamentoId+'"]').val());
            if(isNaN(areaComun)) areaComun = 0;
            var alcantarillado = parseFloat($('[name^="cuota-alcantarillado-' + departamentoId+'"]').val());
            if(isNaN(alcantarillado)) alcantarillado = 0;
            var cargoFijo = parseFloat($('[name^="cuota-cargo-fijo-' + departamentoId+'"]').val());
            if(isNaN(cargoFijo)) cargoFijo = 0;
            var subTotalAgua = (consumoSoles + areaComun + alcantarillado + cargoFijo);
            var igvAgua = subTotalAgua * 0.18;
            var totalAgua = subTotalAgua + igvAgua;
            var cuota = parseFloat($('[name^="cuota-cuota-' + departamentoId+'"]').val());
            if(isNaN(cuota)) cuota = 0;
            var extraordinario = parseFloat($('[name^="cuota-cuota-extraordinaria-' + departamentoId+'"]').val());
            if(isNaN(extraordinario)) extraordinario = 0;
            var total = totalAgua + cuota + extraordinario;

            $('[name^="cuota-consumo-soles-' + departamentoId+'"]').val(consumoSoles.toFixed(2));
            $('[name^="cuota-area-comun-' + departamentoId+'"]').val(areaComun.toFixed(2));
            $('[name^="cuota-alcantarillado-' + departamentoId+'"]').val(alcantarillado.toFixed(2));
            $('[name^="cuota-cargo-fijo-' + departamentoId+'"]').val(cargoFijo.toFixed(2));
            $('[name^="cuota-igv-' + departamentoId+'"]').val(igvAgua.toFixed(2));
            $('[name^="cuota-consumo-total-agua-' + departamentoId+'"]').val(totalAgua.toFixed(2));
            $('[name^="cuota-cuota-' + departamentoId+'"]').val(cuota.toFixed(2));
            $('[name^="cuota-cuota-extraordinario' + departamentoId+'"]').val(extraordinario.toFixed(2));
            $('[name^="cuota-total-' + departamentoId+'"]').val(total.toFixed(2));
        }

        function actualizarTotalesCabeceras()
        {

            $("#comun-lectura-anterior").text(sumaTodo('[name^="comun-lectura-anterior"]'));
            $("#comun-lectura-actual").text(sumaTodo('[name^="cuota-lectura-actual"]'));
            $("#comun-consumo-agua").text(sumaTodo('[name^="cuota-consumo-agua"]'));

            $("#comun-igv").text(sumaTodo('[name^="cuota-igv"]'));
            $("#comun-consumo-agua-total").text(sumaTodo('[name^="cuota-consumo-total-agua"]'));
            $("#comun-cuota").text(sumaTodo('[name^="cuota-cuota"]'));
            $("#comun-cuota-extraordinaria").text(sumaTodo('[name^="cuota-cuota-extraordinaria"]'));
            $("#comun-total").text(sumaTodo('[name^="cuota-total"]'));
        }

        $(document).ready(function () {
            actualizarTotales();

            $('.row-departamento input').change(function(){
                var clase = $(this).attr('class');
                if(clase != 'total'){
                    var departamentoId = $(this).closest('tr').data('departamento-id');
                    actualizarTotalesCabeceras();
                    actualizarConsumoAgua();
                    actualizarTotalesDepartamento(departamentoId);
                    actualizarTotalesCabeceras();
                }
            });

            $('.row-departamento input').keydown(function(e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 9) {
                    e.preventDefault();
                    var nombreCompoenete = this.name.substring(0,this.name.lastIndexOf('-'));
                    var siguienteComponente = $(this).closest('tr').next().find('[name^="'+nombreCompoenete+'"]');
                    siguienteComponente.focus(function() { $(this).select(); } ).focus();
                }
            });

            $('[name="comun-area-comun"]').change(function () {
                actualizarTotales();
            })

            $('[name="comun-alcantarillado"]').change(function () {
                actualizarTotales();
            })

            $('[name="comun-cargo-fijo"]').change(function () {
                actualizarTotales();
            })

            $('[name="comun-consumo-soles"]').change(function () {
                actualizarConsumoAgua();
                actualizarTotales();
            })

            $('[name^="cuota-lectura-actual"]').change(function(){
                actualizarTotales();
            });

            $('[name^="cuota-cuota-extraordinaria"]').change(function(){
                actualizarTotales();
            });
            $( "#btn-agregar-gastos" ).click(function(e) {
                AgregarGasto();
            });
            $( "#btnAgregarGasto" ).click(function(e) {
                e.preventDefault();
            });

            @foreach (var item in dicCuotas)
            {
                <text>
                    $('[name^="@item.Key"]').val('@item.Value');
                    //var cal = parseFloat($('[name=comun-lectura-anterior]').val()) - parseFloat($('[name=cuota-lectura-actual]').val());
                </text>
            }
            //    background-color: #ffe5e5;
        });
    </script>

    <script>
        function CambiarConsumoAguaTotal()
        {
            $('[name^="cuota-consumo-agua"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                var valor = parseFloat($("#FijarCuotaAgua").val());
                $('[name^="cuota-consumo-total-agua-' + departamentoId+'"]').val(valor.toFixed(2));
                var cuota = parseFloat($('[name^="cuota-cuota-' + departamentoId+'"]').val());
                if(isNaN(cuota)) cuota = 0;
                var extraordinario = parseFloat($('[name^="cuota-cuota-extraordinaria-' + departamentoId+'"]').val());
                if(isNaN(extraordinario)) extraordinario = 0;
                var total = valor + cuota + extraordinario;
                $('[name^="cuota-total-' + departamentoId+'"]').val(total.toFixed(2));
            });

        }
        function CambiarConsumoAguaTotalRecibo()
        {
            var totalSaldoComun = (parseFloat($("#comun-consumo-agua").text()))*($('[name^=comun-consumo-soles]').first().val());
            var campoModificar = $('[name^=comun-area-comun]').first();
            campoModificar.val(Math.round((($("#TotalReciboCuotaAgua").val())-totalSaldoComun)*100)/100);
            actualizarTotales();
        }

        function CambiarCuotaExtraordinariaTotal()
        {
            $('[name^="cuota-cuota-extraordinaria-"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);
                var valor = parseFloat($("#FijarCuotaExtraordinaria").val());
                $('[name^="cuota-cuota-extraordinaria-' + departamentoId+'"]').val(valor.toFixed(2));
                var cuota = parseFloat($('[name^="cuota-cuota-' + departamentoId+'"]').val());
                if(isNaN(cuota)) cuota = 0;
                var extraordinario = parseFloat($('[name^="cuota-cuota-extraordinaria-' + departamentoId+'"]').val());
                if(isNaN(extraordinario)) extraordinario = 0;
                var total = valor + cuota + extraordinario;
                $('[name^="cuota-total-' + departamentoId+'"]').val(total.toFixed(2));
            });

        }
        function CambiarUsarDefaults()
        {

            $('[name^="cuota-consumo-agua"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);

                var cuotadef = parseFloat($('[name^="hidden-cuotadefault-' + departamentoId+'"]').val());

                if(isNaN(cuotadef)) cuotadef = 0;
                var cuota = cuotadef;
                $('[name^="cuota-cuota-' + departamentoId+'"]').val(cuota.toFixed(2));
                var extraordinario = parseFloat($('[name^="cuota-cuota-extraordinaria-' + departamentoId+'"]').val());
                if(isNaN(extraordinario)) extraordinario = 0;
                var total =  cuota + extraordinario;
                $('[name^="cuota-total-' + departamentoId+'"]').val(total.toFixed(2));
            });

        }
        function AnularIgv()
        {

            $('[name^="cuota-consumo-agua"]').each(function (i, e) {
                var departamentoId = obtenerDepartamento(e.name);


                $('[name^="cuota-igv-' + departamentoId+'"]').val(0.00);
            });

        }
    </script>
}
